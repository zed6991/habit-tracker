<script>
  const habitInput = document.getElementById('habitInput');
  const habitBody = document.getElementById('habitBody');

  // Load habits or initialize empty
  let habits = JSON.parse(localStorage.getItem('habits') || '[]');

  function saveHabits() {
    localStorage.setItem('habits', JSON.stringify(habits));
  }

  // Calculate % progress for a habit (how many days done / 13)
  function getProgress(weeks) {
    if (!weeks) return 0;
    const doneCount = weeks.filter(Boolean).length;
    return Math.round((doneCount / 13) * 100);
  }

  function renderHabits() {
    habitBody.innerHTML = '';
    habits.forEach((habit, habitIndex) => {
      const tr = document.createElement('tr');

      // Habit name cell
      const nameTd = document.createElement('td');
      nameTd.textContent = habit.name;
      nameTd.className = 'habit-name';
      tr.appendChild(nameTd);

      // For each of the 13 days, create a cell
      for(let i = 0; i < 13; i++) {
        const td = document.createElement('td');
        td.className = 'week-cell';
        if(habit.weeks && habit.weeks[i]) {
          td.classList.add('done');
        }

        td.onclick = () => {
          habit.weeks = habit.weeks || [];
          habit.weeks[i] = !habit.weeks[i];  // toggle
          saveHabits();
          renderHabits();
        };

        tr.appendChild(td);
      }

      // Progress cell
      const progressTd = document.createElement('td');
      progressTd.textContent = getProgress(habit.weeks) + '%';
      tr.appendChild(progressTd);

      // Delete button cell
      const deleteTd = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'delete-btn';
      deleteBtn.onclick = () => {
        if (confirm(`Delete habit "${habit.name}"?`)) {
          habits.splice(habitIndex, 1);
          saveHabits();
          renderHabits();
        }
      };
      deleteTd.appendChild(deleteBtn);
      tr.appendChild(deleteTd);

      habitBody.appendChild(tr);
    });
  }

  function addHabit() {
    const name = habitInput.value.trim();
    if(!name) {
      alert('Please enter a habit');
      return;
    }
    habits.push({ name, weeks: Array(13).fill(false) });
    saveHabits();
    renderHabits();
    habitInput.value = '';
  }

  // Export habits data as JSON file
  function exportData() {
    const dataStr = JSON.stringify(habits, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'habit-tracker-data.json';
    a.click();

    URL.revokeObjectURL(url);
  }

  // Initial render
  renderHabits();
</script>
